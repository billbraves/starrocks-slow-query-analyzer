# StarRocks 慢 SQL 分析工具 - 使用指南

## 📚 目录

1. [快速开始](#快速开始)
2. [Claude Code 集成](#claude-code-集成)
3. [常见使用场景](#常见使用场景)
4. [最佳实践](#最佳实践)
5. [故障排查](#故障排查)

## 🚀 快速开始

### 步骤 1: 安装依赖

```bash
pip install -r requirements.txt
```

### 步骤 2: 配置数据库连接

编辑 `config.yaml`，设置你的 StarRocks 连接信息：

```yaml
database:
  host: "your_starrocks_host"
  port: 9030
  user: "your_username"
  password: "your_password"
  database: "information_schema"
```

### 步骤 3: 运行第一次分析

```bash
python starrocks_slow_query_analyzer.py
```

报告将生成在 `./reports` 目录下。

## 🤖 Claude Code 集成

### 配置自定义 Skill

1. 确保自定义 Skill 文件已放置在 `.claude/skills/starrocks_slow_query_analysis.md`
2. 在 Claude Code 中，该 Skill 会自动加载
3. 现在可以直接与 Claude Code 对话进行慢 SQL 分析

### 对话示例

#### 场景 1: 常规分析

```
你: 请帮我分析 StarRocks 过去 24 小时的慢 SQL

Claude: 正在收集慢 SQL 数据...
       找到 156 条慢查询
       分析完成，报告已生成: ./reports/slow_query_report_20231230_143022.html
       
       关键发现:
       - 平均执行时间: 3.42s
       - 最慢查询: 45.8s
       - 主要问题: 缺少索引、使用 SELECT *
       
       建议优先处理 5 个 CRITICAL 级别的查询
```

#### 场景 2: 深度诊断

```
你: 请详细分析与表 orders 相关的慢查询，重点看执行计划

Claude: 正在分析 orders 表相关的查询...
       找到 42 个相关查询
       
       主要问题:
       1. 全表扫描: 18 个查询未使用索引
       2. JOIN 低效: orders 与 users 表的 JOIN 未优化
       3. 扫描行数过多: 平均扫描 850万 行
       
       优化建议:
       - 为 orders.user_id 创建索引
       - 考虑添加复合索引 (user_id, status)
       - 使用分区裁剪减少扫描范围
```

#### 场景 3: SQL 诊断

```
你: 请帮我诊断这个 SQL 的性能问题：

SELECT * FROM orders 
WHERE create_time > '2024-01-01'
AND status IN ('pending', 'processing')

Claude: 分析完成！发现以下问题:
       
       ⚠️ 问题 1: SELECT * [MEDIUM]
          描述: 返回所有列可能包含不必要的数据
          建议: 只选择需要的列
          预期提升: 减少 40%-60% 数据传输
       
       ⚠️ 问题 2: 缺少索引 [HIGH]
          描述: create_time 列可能缺少索引
          建议: 为 create_time 创建索引
          SQL: CREATE INDEX idx_create_time ON orders(create_time);
          预期提升: 查询时间从 5.2s 降至 0.3s
       
       ⚠️ 问题 3: 扫描行数过多 [HIGH]
          描述: 预计扫描 200万 行数据
          建议: 添加更多过滤条件或使用分区
          预期提升: 减少 70%-80% 扫描行数
```

#### 场景 4: 持续监控

```
你: 请帮我设置定期巡检，每天早上 8 点分析过去 24 小时的慢 SQL

Claude: 好的，我来帮你设置定期巡检：
       
       1. 创建巡检脚本 daily_analysis.sh:
          ```bash
          #!/bin/bash
          cd /path/to/your/project
          python starrocks_slow_query_analyzer.py \
              --time-range 24 \
              --format html
          ```
       
       2. 设置 crontab:
          ```bash
          0 8 * * * /path/to/daily_analysis.sh
          ```
       
       3. 建议同时发送邮件通知，报告位置:
          - HTML 报告: ./reports/slow_query_report_*.html
          - 可配置邮件服务自动发送
```

## 🎯 常见使用场景

### 场景 1: 上线后性能监控

```bash
# 上线后持续监控
while true; do
    python starrocks_slow_query_analyzer.py \
        --time-range 1 \
        --threshold 2.0
    sleep 3600  # 每小时分析一次
done
```

### 场景 2: 性能问题排查

```bash
# 排查特定时间段的慢查询
python starrocks_slow_query_analyzer.py \
    --time-range 2 \
    --database production_db \
    --format markdown
```

### 场景 3: 专项优化

```bash
# 只分析涉及核心表的查询
python starrocks_slow_query_analyzer.py \
    --time-range 48 \
    --pattern "core_table"
```

### 场景 4: 用户行为分析

```bash
# 分析特定用户的查询模式
python starrocks_slow_query_analyzer.py \
    --user "data_analyst" \
    --time-range 168  # 过去一周
```

## 💡 最佳实践

### 1. 定期巡检

建议设置自动化巡检流程：

```bash
# 每天凌晨分析
0 2 * * * python starrocks_slow_query_analyzer.py --time-range 24

# 每周汇总分析
0 3 * * 1 python starrocks_slow_query_analyzer.py --time-range 168
```

### 2. 分级处理

根据严重程度优先处理：

- **CRITICAL**: 立即处理（执行时间 > 10s）
- **HIGH**: 当天处理（执行时间 5-10s）
- **MEDIUM**: 本周处理（执行时间 1-5s）
- **LOW**: 记录观察（执行时间 < 1s 但频繁）

### 3. 持续优化

建立优化反馈循环：

1. 识别慢 SQL
2. 分析问题根因
3. 应用优化建议
4. 验证优化效果
5. 更新规范文档

### 4. 团队协作

- 分享分析报告给团队
- 建立慢 SQL 审查机制
- 定期进行性能培训
- 记录优化案例

## 🔧 故障排查

### 问题 1: 无法连接到 StarRocks

**症状**: 提示连接失败

**解决方法**:
1. 检查 `config.yaml` 中的连接配置
2. 确认 FE 服务是否运行: `ps aux | grep starrocks_fe`
3. 测试网络连通性: `telnet host 9030`
4. 检查防火墙规则

### 问题 2: 没有慢查询数据

**症状**: 分析结果为空

**解决方法**:
1. 确认 query_log 功能已开启:
   ```sql
   SET GLOBAL enable_query_log = true;
   ```
2. 检查时间范围设置是否合理
3. 确认阈值设置是否过低
4. 检查是否有查询在指定时间范围内执行

### 问题 3: 报告生成失败

**症状**: 报告文件未生成

**解决方法**:
1. 检查报告目录权限
2. 确认磁盘空间充足
3. 查看日志文件获取详细错误
4. 尝试不同的报告格式

### 问题 4: 分析速度慢

**症状**: 分析过程耗时过长

**解决方法**:
1. 减少时间范围
2. 增大阈值，减少查询数量
3. 使用数据库过滤减少数据量
4. 考虑使用 JSON 格式（生成速度更快）

## 📊 性能指标说明

### 执行时间
- **< 1s**: 正常
- **1-5s**: 需要关注
- **5-10s**: 需要优化
- **> 10s**: 严重问题

### 扫描行数
- **< 100万**: 正常
- **100万-1000万**: 需要关注
- **> 1000万**: 需要优化

### 内存使用
- **< 100MB**: 正常
- **100MB-500MB**: 需要关注
- **> 500MB**: 需要优化

## 🔗 相关资源

- [StarRocks 官方文档](https://docs.starrocks.io/)
- [Claude Code 文档](https://docs.anthropic.com/)
- [SQL 优化最佳实践](https://docs.starrocks.io/docs/sql-reference/sql-statements/)

## 📞 技术支持

遇到问题？请查看：
1. GitHub Issues
2. 日志文件: `./logs/`
3. 错误信息详情

## 📈 版本历史

- **v1.0.0** (2024-01-01)
  - 初始版本
  - 支持基础的慢 SQL 分析
  - 支持多种报告格式
  - Claude Code 集成

